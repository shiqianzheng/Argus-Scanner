rules:
  # ============================================================================
  # 网络活动 (Network Activities)
  # ============================================================================
  - id: NETWORK-001
    title: "外发现网络连接"
    # 使用负向预查排除内网 IP (127.x, 10.x, 192.168.x, 172.16-31.x)
    pattern: 'connect\(.*sin_addr=inet_addr\("(?P<ip>(?!127\.|10\.|192\.168\.|172\.(?:1[6-9]|2[0-9]|3[01])\.)[^"]+)"\)'
    description: "程序发起了一个指向外部互联网 IP 的网络连接，可能涉及外联 C2 服务器或数据外泄。"
    severity: MEDIUM
    category: network
    exclude_ips: ["0.0.0.0", "::1"]

  - id: NETWORK-002
    title: "可疑端口绑定"
    pattern: 'bind\(.*sin_port=htons\((?P<port>\d+)\)'
    description: "程序尝试绑定到网络端口，可能在尝试开启后门监听或充当服务器。"
    severity: MEDIUM
    category: network
    exclude_ports: [8080, 8000, 3000, 5000] # 允许常见开发端口

  # ============================================================================
  # 文件系统活动 (File System Activities)
  # ============================================================================
  - id: FS-001
    title: "敏感文件访问"
    # 移除 harmless 的 hosts/resolv.conf 读取
    pattern: 'openat\(.*"(?P<file>/etc/(shadow|passwd))"'
    description: "程序访问了关键的系统认证文件（如 /etc/passwd 或 /etc/shadow），涉及提权或信息收集。"
    severity: HIGH
    category: filesystem

  - id: FS-002
    title: "二进制路径篡改"
    pattern: 'openat\(.*"(?P<file>/(bin|sbin|usr/bin|usr/sbin)/[^"]+)".*O_((WRONLY)|(RDWR)|(CREAT))'
    description: "程序尝试以写入模式打开系统二进制目录下的文件，可能在尝试替换系统命令实现持久化。"
    severity: CRITICAL
    category: filesystem

  # ============================================================================
  # 进程活动 (Process Activities)
  # ============================================================================
  - id: PROC-001
    title: "Shell 执行行为"
    pattern: 'execve\("(?P<cmd>/(bin|usr/bin)/(bash|sh|zsh|dash))"'
    description: "程序启动了一个交互式 Shell，这通常是反弹 Shell 或恶意指令执行的特征。"
    severity: HIGH
    category: process

  - id: PROC-002
    title: "进程隐藏(重命名)"
    pattern: 'prctl\(PR_SET_NAME, "(?P<name>[^"]+)"\)'
    description: "程序尝试更改其进程名称，这是木马常用的逃逸手段，用以伪装成合法进程。"
    severity: MEDIUM
    category: evasion

  # ============================================================================
  # 内存活动 (Memory Activities) - New! mmap/mprotect
  # ============================================================================
  - id: MEM-001
    title: "可执行内存分配 (mmap)"
    pattern: 'mmap\(.*PROT_EXEC.*'
    description: "检测到程序直接分配可执行权限的内存区域，通常用于 Shellcode 加载或 JIT Spray 攻击。"
    severity: HIGH
    category: memory

  - id: MEM-002
    title: "内存权限修改 (mprotect)"
    pattern: 'mprotect\(.*PROT_EXEC.*'
    description: "检测到程序将现有内存区域修改为可执行权限，这是代码注入或解密执行的典型行为。"
    severity: HIGH
    category: memory

  - id: MEM-003
    title: "进程注入尝试 (ptrace)"
    pattern: 'ptrace\(PTRACE_(POKETEXT|POKEDATA|ATTACH).*'
    description: "程序尝试使用 ptrace 操作其他进程的内存或执行流，这是典型的进程注入行为。"
    severity: CRITICAL
    category: memory

  - id: MEM-004
    title: "无文件执行尝试 (memfd_create)"
    pattern: 'memfd_create\("(?P<name>[^"]+)"'
    description: "程序尝试在内存中创建匿名文件。这是无文件攻击（Fileless Attack）的典型特征，用以绕过磁盘扫描。"
    severity: HIGH
    category: memory

  - id: FS-003
    title: "异常文件描述符访问 (proc/fd)"
    pattern: 'openat\(.*"/proc/self/fd/\d+"'
    description: "程序尝试直接通过 /proc/self/fd 访问文件描述符，可能在尝试读取或执行隐藏在内存中的匿名文件。"
    severity: HIGH
    category: filesystem
